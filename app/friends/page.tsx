"use client";

import { useState, useEffect } from "react";
import { createClient } from "@supabase/supabase-js";
import Link from "next/link";
import styles from "../calendar/calendar.module.css";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
const supabase = createClient(supabaseUrl, supabaseKey);

export default function FriendsPage() {
  const [inviteEmail, setInviteEmail] = useState("");
  const [inviteMsg, setInviteMsg] = useState("");
  const [friends, setFriends] = useState<any[]>([]);
  const [pendingReceived, setPendingReceived] = useState<any[]>([]);
  const [pendingSent, setPendingSent] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState<any>(null);

  // ‚úÖ L·∫•y user t·ª´ localStorage
  useEffect(() => {
    const savedUser = JSON.parse(localStorage.getItem("user") || "{}");
    if (savedUser?.id) setUser(savedUser);
  }, []);

  // ‚úÖ L·∫•y danh s√°ch b·∫°n b√® khi c√≥ user
  useEffect(() => {
    if (user?.id) fetchFriends();
  }, [user]);

  // ‚úÖ G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n
  const handleInvite = async (e: React.FormEvent) => {
    e.preventDefault();
    setInviteMsg("");

    if (!inviteEmail) return setInviteMsg("‚ö†Ô∏è Vui l√≤ng nh·∫≠p email b·∫°n b√®.");
    if (inviteEmail === user.email)
      return setInviteMsg("‚ö†Ô∏è Kh√¥ng th·ªÉ t·ª± g·ª≠i l·ªùi m·ªùi cho ch√≠nh m√¨nh.");

    try {
      // üîπ 1. T√¨m receiver_id qua b·∫£ng profiles
      const { data: receiverProfile, error: findErr } = await supabase
        .from("profiles")
        .select("id, email")
        .eq("email", inviteEmail)
        .single();

      if (findErr || !receiverProfile)
        return setInviteMsg("‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng c√≥ email n√†y.");

      const receiver_id = receiverProfile.id;

      // üîπ 2. Ki·ªÉm tra xem ƒë√£ c√≥ l·ªùi m·ªùi ch∆∞a
      const { data: existing } = await supabase
        .from("friends")
        .select("*")
        .or(
          `and(sender_id.eq.${user.id},receiver_id.eq.${receiver_id}),and(sender_id.eq.${receiver_id},receiver_id.eq.${user.id})`
        )
        .maybeSingle();

      if (existing)
        return setInviteMsg("‚ö†Ô∏è L·ªùi m·ªùi ƒë√£ t·ªìn t·∫°i ho·∫∑c hai ng∆∞·ªùi ƒë√£ l√† b·∫°n.");

      // üîπ 3. G·ª≠i l·ªùi m·ªùi v√†o b·∫£ng friends
      const { data: inserted, error } = await supabase
        .from("friends")
        .insert([
          {
            sender_id: user.id,
            receiver_id,
            sender_email: user.email,
            receiver_email: inviteEmail,
            status: "pending",
          },
        ])
        .select()
        .single(); // üëà ƒë·ªÉ l·∫•y inviteId cho b∆∞·ªõc g·ª≠i email

      if (error) throw error;

      // üîπ 4. Sau khi insert th√†nh c√¥ng ‚Üí g·ªçi API g·ª≠i email qua Resend
      try {
        const res = await fetch("/api/send-invite", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            to: inviteEmail,
            fromUser: user.email,
            inviteId: inserted.id, // üëà d√πng ID b·∫°n v·ª´a t·∫°o
          }),
        });

        const result = await res.json();
        if (res.ok && result.success) {
          setInviteMsg("‚úÖ ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n v√† email th√¥ng b√°o!");
        } else {
          console.error("Email g·ª≠i l·ªói:", result.error);
          setInviteMsg("‚ö†Ô∏è ƒê√£ g·ª≠i l·ªùi m·ªùi, nh∆∞ng l·ªói khi g·ª≠i email.");
        }
      } catch (mailErr) {
        console.error("L·ªói g·ª≠i email:", mailErr);
        setInviteMsg("‚ö†Ô∏è ƒê√£ g·ª≠i l·ªùi m·ªùi, nh∆∞ng l·ªói khi g·ª≠i email.");
      }

      // üîπ 5. L√†m m·ªõi giao di·ªán
      setInviteEmail("");
      fetchFriends();
    } catch (err: any) {
      console.error(err);
      setInviteMsg("‚ùå L·ªói khi g·ª≠i l·ªùi m·ªùi: " + err.message);
    }
  };


  // ‚úÖ L·∫•y danh s√°ch b·∫°n b√® & l·ªùi m·ªùi
  const fetchFriends = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from("friends")
        .select("*")
        .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`);

      if (error) throw error;

      // Ph√¢n lo·∫°i
      const accepted = data.filter((f) => f.status === "accepted");
      const received = data.filter(
        (f) => f.status === "pending" && f.receiver_id === user.id
      );
      const sent = data.filter(
        (f) => f.status === "pending" && f.sender_id === user.id
      );

      setFriends(accepted);
      setPendingReceived(received);
      setPendingSent(sent);
    } catch (err) {
      console.error("fetchFriends error:", err);
    } finally {
      setLoading(false);
    }
  };

  // ‚úÖ C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªùi m·ªùi
  const handleUpdateStatus = async (friendId: string, newStatus: string) => {
    try {
      const { error } = await supabase
        .from("friends")
        .update({ status: newStatus, updated_at: new Date() })
        .eq("id", friendId);

      if (error) throw error;

      alert(
        newStatus === "accepted"
          ? "‚úÖ ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi!"
          : "‚ùå ƒê√£ t·ª´ ch·ªëi l·ªùi m·ªùi!"
      );
      fetchFriends();
    } catch (err: any) {
      alert("‚ö†Ô∏è L·ªói khi c·∫≠p nh·∫≠t: " + err.message);
    }
  };

  // ‚úÖ H·ªßy l·ªùi m·ªùi (ch·ªâ ng∆∞·ªùi g·ª≠i ƒë∆∞·ª£c h·ªßy)
  const handleCancelInvite = async (friendId: string) => {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy l·ªùi m·ªùi n√†y?")) return;

    try {
      const { error } = await supabase
        .from("friends")
        .delete()
        .eq("id", friendId);

      if (error) throw error;
      alert("üóë ƒê√£ h·ªßy l·ªùi m·ªùi!");
      fetchFriends();
    } catch (err: any) {
      alert("‚ùå L·ªói khi h·ªßy l·ªùi m·ªùi: " + err.message);
    }
  };

  // ‚úÖ X√≥a b·∫°n b√®
  const handleDeleteFriend = async (friendId: string) => {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫°n n√†y?")) return;

    try {
      const { error } = await supabase
        .from("friends")
        .delete()
        .eq("id", friendId);

      if (error) throw error;
      alert("üóë ƒê√£ x√≥a b·∫°n th√†nh c√¥ng!");
      fetchFriends();
    } catch (err: any) {
      alert("‚ùå X√≥a th·∫•t b·∫°i: " + err.message);
    }
  };

  if (!user)
    return (
      <div style={{ padding: "40px", textAlign: "center" }}>
        ‚è≥ ƒêang t·∫£i th√¥ng tin ng∆∞·ªùi d√πng...
      </div>
    );

  return (
    <div style={{ padding: "40px", textAlign: "center" }}>
      <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 20 }}>
        üë• Qu·∫£n l√Ω b·∫°n b√®
      </h2>

      {/* G·ª¨I L·ªúI M·ªúI */}
      <div
        className={styles.friendInviteWidget}
        style={{
          maxWidth: 400,
          margin: "0 auto 40px",
          padding: 20,
          borderRadius: 12,
          background: "#f9fafb",
          boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
        }}
      >
        <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 12 }}>
          ‚úâÔ∏è G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n
        </h3>
        <form onSubmit={handleInvite} style={{ display: "flex", gap: 8 }}>
          <input
            type="email"
            placeholder="Nh·∫≠p email b·∫°n b√®..."
            value={inviteEmail}
            onChange={(e) => setInviteEmail(e.target.value)}
            style={{
              flex: 1,
              padding: 8,
              borderRadius: 6,
              border: "1px solid #ccc",
            }}
            required
          />
          <button
            type="submit"
            style={{
              background: "#2563eb",
              color: "#fff",
              border: "none",
              borderRadius: 6,
              padding: "8px 16px",
              fontWeight: 600,
              cursor: "pointer",
            }}
          >
            G·ª≠i
          </button>
        </form>
        {inviteMsg && (
          <div
            style={{
              marginTop: 10,
              color: inviteMsg.startsWith("‚úÖ") ? "#16a34a" : "#dc2626",
            }}
          >
            {inviteMsg}
          </div>
        )}
      </div>

      {/* L·ªúI M·ªúI NH·∫¨N */}
      <div style={{ maxWidth: 500, margin: "0 auto 30px" }}>
        <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 10 }}>
          üì• L·ªùi m·ªùi ƒëang ch·ªù b·∫°n ch·∫•p nh·∫≠n
        </h3>
        {pendingReceived.length === 0 ? (
          <p style={{ color: "#6b7280" }}>Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>
        ) : (
          pendingReceived.map((p) => (
            <div
              key={p.id}
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                background: "#fff",
                padding: "10px 16px",
                borderRadius: 8,
                boxShadow: "0 1px 4px rgba(0,0,0,0.1)",
                marginBottom: 8,
              }}
            >
              <span>{p.sender_email}</span>
              <div style={{ display: "flex", gap: 8 }}>
                <button
                  onClick={() => handleUpdateStatus(p.id, "accepted")}
                  style={{
                    background: "#22c55e",
                    color: "#fff",
                    border: "none",
                    borderRadius: 6,
                    padding: "4px 10px",
                    cursor: "pointer",
                  }}
                >
                  ‚úÖ Ch·∫•p nh·∫≠n
                </button>
                <button
                  onClick={() => handleUpdateStatus(p.id, "rejected")}
                  style={{
                    background: "#ef4444",
                    color: "#fff",
                    border: "none",
                    borderRadius: 6,
                    padding: "4px 10px",
                    cursor: "pointer",
                  }}
                >
                  ‚ùå T·ª´ ch·ªëi
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* L·ªúI M·ªúI B·∫†N ƒê√É G·ª¨I */}
      <div style={{ maxWidth: 500, margin: "0 auto 30px" }}>
        <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 10 }}>
          ‚è≥ L·ªùi m·ªùi b·∫°n ƒë√£ g·ª≠i
        </h3>
        {pendingSent.length === 0 ? (
          <p style={{ color: "#6b7280" }}>Kh√¥ng c√≥ l·ªùi m·ªùi n√†o b·∫°n ƒë√£ g·ª≠i.</p>
        ) : (
          pendingSent.map((p) => (
            <div
              key={p.id}
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                background: "#fff",
                padding: "10px 16px",
                borderRadius: 8,
                boxShadow: "0 1px 4px rgba(0,0,0,0.1)",
                marginBottom: 8,
              }}
            >
              <span>{p.receiver_email}</span>
              <button
                onClick={() => handleCancelInvite(p.id)}
                style={{
                  background: "#f59e0b",
                  color: "#fff",
                  border: "none",
                  borderRadius: 6,
                  padding: "4px 10px",
                  cursor: "pointer",
                }}
              >
                üïì H·ªßy l·ªùi m·ªùi
              </button>
            </div>
          ))
        )}
      </div>

      {/* DANH S√ÅCH B·∫†N B√à */}
      <div style={{ maxWidth: 500, margin: "0 auto" }}>
        <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 10 }}>
          ‚úÖ B·∫°n b√® c·ªßa t√¥i
        </h3>
        {friends.length === 0 ? (
          <p style={{ color: "#6b7280" }}>B·∫°n ch∆∞a c√≥ b·∫°n b√® n√†o.</p>
        ) : (
          friends.map((f) => {
            const friendEmail =
              f.sender_id === user.id
                ? f.receiver_email
                : f.sender_email;
            return (
              <div
                key={f.id}
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  background: "#f1f5f9",
                  padding: "10px 16px",
                  borderRadius: 8,
                  marginBottom: 8,
                }}
              >
                <span>{friendEmail}</span>
                <button
                  onClick={() => handleDeleteFriend(f.id)}
                  style={{
                    background: "#e11d48",
                    color: "#fff",
                    border: "none",
                    borderRadius: 6,
                    padding: "4px 10px",
                    cursor: "pointer",
                  }}
                >
                  üóë X√≥a
                </button>
              </div>
            );
          })
        )}
      </div>

      {/* QUAY L·∫†I */}
      <Link href="/calendar">
        <button
          style={{
            marginTop: 40,
            background: "#475569",
            color: "#fff",
            border: "none",
            borderRadius: 6,
            padding: "8px 16px",
            cursor: "pointer",
          }}
        >
          ‚¨ÖÔ∏è Quay l·∫°i L·ªãch
        </button>
      </Link>
    </div>
  );
}
